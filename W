pcall(function()

if not game.Players.LocalPlayer.Character or game.Players.LocalPlayer.Character:WaitForChild("Humanoid").RigType ~= Enum.HumanoidRigType.R15 then 
    game.StarterGui:SetCore("SendNotification", {Title = "R6", Text = "You're on R6, bro. Change to R15!", Duration = 60})
    return
end

local st = os.clock()
local TweenService = game:GetService("TweenService")
local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local camera = workspace.CurrentCamera

cloneref = cloneref or function(o) return o end
local GazeGoGui = cloneref(game:GetService("CoreGui")) or game:GetService("CoreGui") or game.Players.LocalPlayer:WaitForChild("PlayerGui")

local Notifbro = {}
function Notify(titletxt, text, time)
    coroutine.wrap(function()
        local GUI = Instance.new("ScreenGui")
        local Main = Instance.new("Frame", GUI)
        local title = Instance.new("TextLabel", Main)
        local message = Instance.new("TextLabel", Main)

        GUI.Name = "BackgroundNotif"
        GUI.Parent = GazeGoGui

        local sw = workspace.CurrentCamera.ViewportSize.X
        local sh = workspace.CurrentCamera.ViewportSize.Y
        local nh = sh / 7
        local nw = sw / 5

        Main.Name = "MainFrame"
        Main.BackgroundColor3 = Color3.new(0.156863, 0.156863, 0.156863)
        Main.BackgroundTransparency = 0.2
        Main.BorderSizePixel = 0
        Main.Size = UDim2.new(0, nw, 0, nh)

        title.BackgroundColor3 = Color3.new(0, 0, 0)
        title.BackgroundTransparency = 0.9
        title.Size = UDim2.new(1, 0, 0, nh / 2)
        title.Font = Enum.Font.GothamBold
        title.Text = titletxt
        title.TextColor3 = Color3.new(1, 1, 1)
        title.TextScaled = true

        message.BackgroundColor3 = Color3.new(0, 0, 0)
        message.BackgroundTransparency = 1
        message.Position = UDim2.new(0, 0, 0, nh / 2)
        message.Size = UDim2.new(1, 0, 1, -nh / 2)
        message.Font = Enum.Font.Gotham
        message.Text = text
        message.TextColor3 = Color3.new(1, 1, 1)
        message.TextScaled = true

        local offset = 50
        for _, notif in ipairs(Notifbro) do
            offset = offset + notif.Size.Y.Offset + 10
        end

        Main.Position = UDim2.new(1, 5, 0, offset)
        table.insert(Notifbro, Main)

        task.wait(0.1)
        Main:TweenPosition(UDim2.new(1, -nw, 0, offset), Enum.EasingDirection.Out, Enum.EasingStyle.Bounce, 0.5, true)
        Main:TweenSize(UDim2.new(0, nw * 1.06, 0, nh * 1.06), Enum.EasingDirection.Out, Enum.EasingStyle.Elastic, 0.5, true)
        task.wait(0.1)
        Main:TweenSize(UDim2.new(0, nw, 0, nh), Enum.EasingDirection.Out, Enum.EasingStyle.Elastic, 0.2, true)

        task.wait(time)

        Main:TweenSize(UDim2.new(0, nw * 1.06, 0, nh * 1.06), Enum.EasingDirection.In, Enum.EasingStyle.Elastic, 0.2, true)
        task.wait(0.2)
        Main:TweenSize(UDim2.new(0, nw, 0, nh), Enum.EasingDirection.In, Enum.EasingStyle.Elastic, 0.2, true)
        task.wait(0.2)
        Main:TweenPosition(UDim2.new(1, 5, 0, offset), Enum.EasingDirection.In, Enum.EasingStyle.Bounce, 0.5, true)
        task.wait(0.1)

        GUI:Destroy()
        for i, notif in ipairs(Notifbro) do
            if notif == Main then
                table.remove(Notifbro, i)
                break
            end
        end

        for i, notif in ipairs(Notifbro) do
            local newOffset = 50 + (nh + 10) * (i - 1)
            notif:TweenPosition(UDim2.new(1, -nw, 0, newOffset), Enum.EasingDirection.Out, Enum.EasingStyle.Bounce, 0.5, true)
        end
    end)()
end

task.wait(0.1)

local guiName = "GazeVerificator"
if GazeGoGui:FindFirstChild(guiName) then
    Notify("Error","Script Already Executed", 1)
    return
end

local function getScaledSize(relativeWidth, relativeHeight)
    local viewportSize = camera.ViewportSize
    return UDim2.new(0, math.floor(viewportSize.X * relativeWidth), 0, math.floor(viewportSize.Y * relativeHeight))
end

local core = cloneref(game.CoreGui)
local old = core:FindFirstChild("DraggableGui")
if old then old:Destroy() end

local screenGui = Instance.new("ScreenGui")
screenGui.Name = "DraggableGui"
screenGui.Parent = core

-- TALLER WINDOW SIZE - Changed from 0.4 to 0.6 height for more buttons
local frame = Instance.new("TextButton")
frame.Name = "GazeBro"
frame.Text = ""
frame.Size = getScaledSize(0.3, 0.6) -- TALLER: 60% of screen height instead of 40%
frame.Position = UDim2.new(0.5, -getScaledSize(0.3,0.6).X.Offset/2, 0.5, -getScaledSize(0.3,0.6).Y.Offset/2)
frame.BackgroundColor3 = Color3.fromRGB(50,50,50)
frame.BackgroundTransparency = 0.2
frame.BorderSizePixel = 0  -- Remove border for rounded corners
frame.Active = true
frame.Draggable = true

-- Add rounded corners to main frame
local UICorner = Instance.new("UICorner")
UICorner.CornerRadius = UDim.new(0, 12)  -- Curved edges
UICorner.Parent = frame

frame.Parent = screenGui

local holding = false
local startTime = 0
local startPos

local function fadeOut()
    local t = frame.BackgroundTransparency
    while t < 1 do
        if t < 0.7 then
            t = t + 0.05
        else
            t = t + 0.015
        end
        if t > 1 then t = 1 end
        frame.BackgroundTransparency = t
        task.wait(0.02)
    end
end

local function fadeIn()
    local t = frame.BackgroundTransparency
    while t > 0.2 do
        if t > 0.7 then
            t = t - 0.015
        else
            t = t - 0.05
        end
        if t < 0.2 then t = 0.2 end
        frame.BackgroundTransparency = t
        task.wait(0.02)
    end
end

local function movedFar()
    local currentPos = frame.AbsolutePosition
    local dx = math.abs(currentPos.X - startPos.X)
    local dy = math.abs(currentPos.Y - startPos.Y)
    return dx >= 20 or dy >= 20
end

frame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        holding = true
        startTime = os.clock()
        startPos = frame.AbsolutePosition
        
        -- Use heartbeat instead of tight loop
        local connection
        connection = game:GetService("RunService").Heartbeat:Connect(function()
            if not holding then
                connection:Disconnect()
                return
            end
            
            if movedFar() then
                holding = false
                connection:Disconnect()
                return
            end
            
            if os.clock() - startTime >= 3 then
                if frame.BackgroundTransparency < 1 then
                    fadeOut()
                else
                    fadeIn()
                end
                holding = false
                connection:Disconnect()
            end
        end)
    end
end)

frame.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        holding = false
    end
end)

local searchBar = Instance.new("TextBox")
searchBar.Name = "SearchBar"
searchBar.Text = ""
searchBar.PlaceholderText = "Search..."
searchBar.Font = Enum.Font.SourceSans
searchBar.TextScaled = true
searchBar.TextColor3 = Color3.fromRGB(200, 200, 200)
searchBar.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
searchBar.BorderSizePixel = 0
searchBar.Size = UDim2.new(0.9, 0, 0.1, 0) -- Smaller search bar to make room for more buttons
searchBar.Position = UDim2.new(0.05, 0, 0.05, 0) -- Adjusted position
searchBar.ClearTextOnFocus = true

-- Add rounded corners to search bar
local searchBarCorner = Instance.new("UICorner")
searchBarCorner.CornerRadius = UDim.new(0, 8)
searchBarCorner.Parent = searchBar

searchBar.Parent = frame

-- LARGER SCROLL FRAME - More space for buttons
local scrollFrame = Instance.new("ScrollingFrame")
scrollFrame.Name = "ScrollFrame"
scrollFrame.Size = UDim2.new(0.9, 0, 0.8, 0) -- TALLER: 80% of frame height instead of 70%
scrollFrame.Position = UDim2.new(0.05, 0, 0.15, 0) -- Adjusted position
scrollFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
scrollFrame.BorderSizePixel = 0
scrollFrame.ScrollBarThickness = 6 -- Added scrollbar for better navigation
scrollFrame.ScrollingDirection = Enum.ScrollingDirection.Y
scrollFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
scrollFrame.ScrollBarImageTransparency = 0.3 -- Visible scrollbar

-- Add rounded corners to scroll frame
local scrollFrameCorner = Instance.new("UICorner")
scrollFrameCorner.CornerRadius = UDim.new(0, 8)
scrollFrameCorner.Parent = scrollFrame

scrollFrame.Parent = frame

-- LAZY LOADING VARIABLES
local buttons = {}
local createdSet = {}
local animationsLoaded = false
local Animations = {}
local buttonPool = {}
local visibleButtonCount = 15 -- Only show 15 buttons at once
local currentScrollPosition = 0

-- FIXED: REMOVED FILE SYSTEM DEPENDENCIES
local function loadAnimations()
    if animationsLoaded then return Animations end
    
    Animations = {
        ["Idle"] = {
            ["2016 Animation (mm2)"] = {"387947158", "387947464"},
            ["Astronaut"] = {"891621366", "891633237"},
            ["Adidas Community"] = {"122257458498464", "102357151005774"},
            ["Bold"] = {"16738333868", "16738334710"},
            ["Borock"] = {"3293641938", "3293642554"},
            ["Bubbly"] = {"910004836", "910009958"},
            ["Cartoony"] = {"742637544", "742638445"},
            ["Confident"] = {"1069977950", "1069987858"},
            ["Catwalk Glam"] = {"133806214992291","94970088341563"},
            ["Cowboy"] = {"1014390418", "1014398616"},
            ["Drooling Zombie"] = {"3489171152", "3489171152"},
            ["Elder"] = {"10921101664", "10921102574"},
            ["Ghost"] = {"616006778","616008087"},
            ["Knight"] = {"657595757", "657568135"},
            ["Levitation"] = {"616006778", "616008087"},
            ["Mage"] = {"707742142", "707855907"},
            ["MrToilet"] = {"4417977954", "4417978624"},
            ["Ninja"] = {"656117400", "656118341"},
            ["NFL"] = {"92080889861410", "74451233229259"},
            ["OldSchool"] = {"10921230744", "10921232093"},
            ["Patrol"] = {"1149612882", "1150842221"},
            ["Pirate"] = {"750781874", "750782770"},
            ["Default Retarget"] = {"95884606664820", "95884606664820"},
            ["Very Long"] = {"18307781743", "18307781743"},
            ["Sway"] = {"560832030", "560833564"},
            ["Popstar"] = {"1212900985", "1150842221"},
            ["Princess"] = {"941003647", "941013098"},
            ["R6"] = {"12521158637","12521162526"},
            ["R15 Reanimated"] = {"4211217646", "4211218409"},
            ["Realistic"] = {"17172918855", "17173014241"},
            ["Robot"] = {"616088211", "616089559"},
            ["Sneaky"] = {"1132473842", "1132477671"},
            ["Sports (Adidas)"] = {"18537376492", "18537371272"},
            ["Soldier"] = {"3972151362", "3972151362"},
            ["Stylish"] = {"616136790", "616138447"},
            ["Stylized Female"] = {"4708191566", "4708192150"},
            ["Superhero"] = {"10921288909", "10921290167"},
            ["Toy"] = {"782841498", "782845736"},
            ["Udzal"] = {"3303162274", "3303162549"},
            ["Vampire"] = {"1083445855", "1083450166"},
            ["Werewolf"] = {"1083195517", "1083214717"},
            ["Wicked (Popular)"] = {"118832222982049", "76049494037641"},
            ["No Boundaries (Walmart)"] = {"18747067405", "18747063918"},
            ["Zombie"] = {"616158929", "616160636"}
        },
        ["Walk"] = {
            ["Gojo"] = "95643163365384",
            ["Geto"] = "85811471336028",
            ["Astronaut"] = "891667138",
            ["Adidas Community"] = "122150855457006",
            ["Bold"] = "16738340646",
            ["Bubbly"] = "910034870",
            ["Cartoony"] = "742640026",
            ["Confident"] = "1070017263",
            ["Cowboy"] = "1014421541",
            ["Catwalk Glam"] = "109168724482748",
            ["Drooling Zombie"] = "3489174223",
            ["Elder"] = "10921111375",
            ["Ghost"] = "616013216",
            ["Knight"] = "10921127095",
            ["Levitation"] = "616013216",
            ["Mage"] = "707897309",
            ["Ninja"] = "656121766",
            ["NFL"] = "110358958299415",
            ["OldSchool"] = "10921244891",
            ["Patrol"] = "1151231493",
            ["Pirate"] = "750785693",
            ["Default Retarget"] = "115825677624788",
            ["Popstar"] = "1212980338",
            ["Princess"] = "941028902",
            ["R6"] = "12518152696",
            ["R15 Reanimated"] = "4211223236",
            ["2016 Animation (mm2)"] = "387947975",
            ["Robot"] = "616095330",
            ["Sneaky"] = "1132510133",
            ["Sports (Adidas)"] = "18537392113",
            ["Stylish"] = "616146177",
            ["Stylized Female"] = "4708193840",
            ["Superhero"] = "10921298616",
            ["Toy"] = "782843345",
            ["Udzal"] = "3303162967",
            ["Vampire"] = "1083473930",
            ["Werewolf"] = "1083178339",
            ["Wicked (Popular)"] = "92072849924640",
            ["No Boundaries (Walmart)"] = "18747074203",
            ["Zombie"] = "616168032"
        },
        ["Run"] = {
            ["2016 Animation (mm2)"] = "387947975",
            ["Adidas Community"] = "82598234841035",
            ["Astronaut"] = "10921039308",
            ["Bold"] = "16738337225",
            ["Bubbly"] = "10921057244",
            ["Cartoony"] = "10921076136",
            ["Confident"] = "1070001516",
            ["Cowboy"] = "1014401683",
            ["Catwalk Glam"] = "81024476153754",
            ["Drooling Zombie"] = "3489173414",
            ["Elder"] = "10921104374",
            ["Ghost"] = "616013216",
            ["Heavy Run (Udzal / Borock)"] = "3236836670",
            ["Knight"] = "10921121197",
            ["Levitation"] = "616010382",
            ["Mage"] = "10921148209",
            ["MrToilet"] = "4417979645",
            ["Ninja"] = "656118852",
            ["NFL"] = "117333533048078",
            ["OldSchool"] = "10921240218",
            ["Patrol"] = "1150967949",
            ["Pirate"] = "750783738",
            ["Default Retarget"] = "102294264237491",
            ["Popstar"] = "1212980348",
            ["Princess"] = "941015281",
            ["R6"] = "12518152696",
            ["R15 Reanimated"] = "4211220381",
            ["Robot"] = "10921250460",
            ["Sneaky"] = "1132494274",
            ["Sports (Adidas)"] = "18537384940",
            ["Stylish"] = "10921276116",
            ["Stylized Female"] = "4708192705",
            ["Superhero"] = "10921291831",
            ["Toy"] = "10921306285",
            ["Vampire"] = "10921320299",
            ["Werewolf"] = "10921336997",
            ["Wicked (Popular)"] = "72301599441680",
            ["No Boundaries (Walmart)"] = "18747070484",
            ["Zombie"] = "616163682"
        },
        ["Jump"] = {
            ["Astronaut"] = "891627522",
            ["Adidas Community"] = "75290611992385",
            ["Bold"] = "16738336650",
            ["Bubbly"] = "910016857",
            ["Cartoony"] = "742637942",
            ["Catwalk Glam"] = "116936326516985",
            ["Confident"] = "1069984524",
            ["Cowboy"] = "1014394726",
            ["Elder"] = "10921107367",
            ["Ghost"] = "616008936",
            ["Knight"] = "910016857",
            ["Levitation"] = "616008936",
            ["Mage"] = "10921149743",
            ["Ninja"] = "656117878",
            ["NFL"] = "119846112151352",
            ["OldSchool"] = "10921242013",
            ["Patrol"] = "1148811837",
            ["Pirate"] = "750782230",
            ["Default Retarget"] = "117150377950987",
            ["Popstar"] = "1212954642",
            ["Princess"] = "941008832",
            ["Robot"] = "616090535",
            ["R15 Reanimated"] = "4211219390",
            ["R6"] = "12520880485",
            ["Sneaky"] = "1132489853",
            ["Sports (Adidas)"] = "18537380791",
            ["Stylish"] = "616139451",
            ["Stylized Female"] = "4708188025",
            ["Superhero"] = "10921294559",
            ["Toy"] = "10921308158",
            ["Vampire"] = "1083455352",
            ["Werewolf"] = "1083218792",
            ["Wicked (Popular)"] = "104325245285198",
            ["No Boundaries (Walmart)"] = "18747069148",
            ["Zombie"] = "616161997"
        },
        ["Fall"] = {
            ["Astronaut"] = "891617961",
            ["Adidas Community"] = "98600215928904",
            ["Bold"] = "16738333171",
            ["Bubbly"] = "910001910",
            ["Cartoony"] = "742637151",
            ["Catwalk Glam"] = "92294537340807",
            ["Confident"] = "1069973677",
            ["Cowboy"] = "1014384571",
            ["Elder"] = "10921105765",
            ["Knight"] = "10921122579",
            ["Levitation"] = "616005863",
            ["Mage"] = "707829716",
            ["Ninja"] = "656115606",
            ["NFL"] = "129773241321032",
            ["OldSchool"] = "10921241244",
            ["Patrol"] = "1148863382",
            ["Pirate"] = "750780242",
            ["Default Retarget"] = "110205622518029",
            ["Popstar"] = "1212900995",
            ["Princess"] = "941000007",
            ["Robot"] = "616087089",
            ["R15 Reanimated"] = "4211216152",
            ["R6"] = "12520972571",
            ["Sneaky"] = "1132469004",
            ["Sports (Adidas)"] = "18537367238",
            ["Stylish"] = "616134815",
            ["Stylized Female"] = "4708186162",
            ["Superhero"] = "10921293373",
            ["Toy"] = "782846423",
            ["Vampire"] = "1083443587",
            ["Werewolf"] = "1083189019",
            ["Wicked (Popular)"] = "121152442762481",
            ["No Boundaries (Walmart)"] = "18747062535",
            ["Zombie"] = "616157476"
        },
        ["SwimIdle"] = {
            ["Astronaut"] = "891663592",
            ["Adidas Community"] = "109346520324160",
            ["Bold"] = "16738339817",
            ["Bubbly"] = "910030921",
            ["Cartoony"] = "10921079380",
            ["Catwalk Glam"] = "98854111361360",
            ["Confident"] = "1070012133",
            ["CowBoy"] = "1014411816",
            ["Elder"] = "10921110146",
            ["Mage"] = "707894699",
            ["Ninja"] = "656118341",
            ["NFL"] = "79090109939093",
            ["Patrol"] = "1151221899",
            ["Knight"] = "10921125935",
            ["OldSchool"] = "10921244018",
            ["Levitation"] = "10921139478",
            ["Popstar"] = "1212998578",
            ["Princess"] = "941025398",
            ["Pirate"] = "750785176",
            ["R6"] = "12518152696",
            ["Robot"] = "10921253767",
            ["Sneaky"] = "1132506407",
            ["Sports (Adidas)"] = "18537387180",
            ["Stylish"] = "10921281964",
            ["Stylized"] = "4708190607",
            ["SuperHero"] = "10921297391",
            ["Toy"] = "10921310341",
            ["Vampire"] = "10921325443",
            ["Werewolf"] = "10921341319",
            ["Wicked (Popular)"] = "113199415118199",
            ["No Boundaries (Walmart)"] = "18747071682"
        },
        ["Swim"] = {
            ["Astronaut"] = "891663592",
            ["Adidas Community"] = "133308483266208",
            ["Bubbly"] = "910028158",
            ["Bold"] = "16738339158",
            ["Cartoony"] = "10921079380",
            ["Catwalk Glam"] = "134591743181628",
            ["CowBoy"] = "1014406523",
            ["Confident"] = "1070009914",
            ["Elder"] = "10921108971",
            ["Knight"] = "10921125160",
            ["Mage"] = "707876443",
            ["NFL"] = "132697394189921",
            ["OldSchool"] = "10921243048",
            ["PopStar"] = "1212998578",
            ["Princess"] = "941018893",
            ["Pirate"] = "750784579",
            ["Patrol"] = "1151204998",
            ["R6"] = "12518152696",
            ["Robot"] = "10921253142",
            ["Levitation"] = "10921138209",
            ["Stylish"] = "10921281000",
            ["SuperHero"] = "10921295495",
            ["Sneaky"] = "1132500520",
            ["Sports (Adidas)"] = "18537389531",
            ["Toy"] = "10921309319",
            ["Vampire"] = "10921324408",
            ["Werewolf"] = "10921340419",
            ["Wicked (Popular)"] = "99384245425157",
            ["No Boundaries (Walmart)"] = "18747073181",
            ["Zombie"] = "616165109"
        },
        ["Climb"] = {
            ["Astronaut"] = "10921032124",
            ["Adidas Community"] = "88763136693023",
            ["Bold"] = "16738332169",
            ["Cartoony"] = "742636889",
            ["Catwalk Glam"] = "119377220967554",
            ["Confident"] = "1069946257",
            ["CowBoy"] = "1014380606",
            ["Elder"] = "845392038",
            ["Ghost"] = "616003713",
            ["Knight"] = "10921125160",
            ["Levitation"] = "10921132092",
            ["Mage"] = "707826056",
            ["Ninja"] = "656114359",
            ["NFL"] = "134630013742019",
            ["OldSchool"] = "10921229866",
            ["Patrol"] = "1148811837",
            ["Popstar"] = "1213044953",
            ["Princess"] = "940996062",
            ["R6"] = "12520982150",
            ["Reanimated R15"] = "4211214992",
            ["Robot"] = "616086039",
            ["Sneaky"] = "1132461372",
            ["Sports (Adidas)"] = "18537363391",
            ["Stylish"] = "10921271391",
            ["Stylized Female"] = "4708184253",
            ["SuperHero"] = "10921286911",
            ["Toy"] = "10921300839",
            ["Vampire"] = "1083439238",
            ["WereWolf"] = "10921329322",
            ["Wicked (Popular)"] = "131326830509784",
            ["No Boundaries (Walmart)"] = "18747060903",
            ["Zombie"] = "616156119"
        }
    }
    
    animationsLoaded = true
    return Animations
end

-- BUTTON POOL MANAGEMENT
local function createButtonPool()
    for i = 1, visibleButtonCount do
        local button = Instance.new("TextButton")
        button.Name = "PoolButton_" .. i
        button.Font = Enum.Font.SourceSansBold
        button.TextScaled = true
        button.TextColor3 = Color3.fromRGB(255, 255, 255)
        button.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
        button.Size = UDim2.new(1, 0, 0, 35)
        button.Position = UDim2.new(0, 0, 0, (i-1) * 40)
        button.BackgroundTransparency = 0
        button.BorderSizePixel = 0
        button.Visible = false

        local buttonCorner = Instance.new("UICorner")
        buttonCorner.CornerRadius = UDim.new(0, 6)
        buttonCorner.Parent = button

        button.Parent = scrollFrame
        table.insert(buttonPool, button)
    end
end

createButtonPool()

-- VIRTUALIZED SCROLLING
local allAnimationData = {}
local filteredAnimationData = {}

local function populateAnimationData()
    local typeOrder = {"Idle", "Walk", "Run", "Jump", "Fall", "Swim", "SwimIdle", "Climb"}
    
    for _, animType in ipairs(typeOrder) do
        local anims = Animations[animType]
        if anims then
            for name, ids in pairs(anims) do
                table.insert(allAnimationData, {
                    name = name,
                    type = animType,
                    ids = ids,
                    displayText = name .. " - " .. animType
                })
            end
        end
    end
    
    filteredAnimationData = allAnimationData
end

-- FIXED: Store animation data directly on buttons to prevent wrong assignments
local function updateVisibleButtons()
    local searchText = searchBar.Text:lower()
    
    -- Filter data if needed
    if searchText ~= "" then
        filteredAnimationData = {}
        for _, data in ipairs(allAnimationData) do
            if data.displayText:lower():find(searchText) then
                table.insert(filteredAnimationData, data)
            end
        end
    else
        filteredAnimationData = allAnimationData
    end
    
    -- Calculate visible range
    local scrollPosition = scrollFrame.CanvasPosition.Y
    local startIndex = math.floor(scrollPosition / 40) + 1
    local endIndex = math.min(startIndex + visibleButtonCount - 1, #filteredAnimationData)
    
    -- Update button pool
    for i, button in ipairs(buttonPool) do
        local dataIndex = startIndex + i - 1
        
        if dataIndex <= endIndex then
            local data = filteredAnimationData[dataIndex]
            button.Text = data.displayText
            button.Position = UDim2.new(0, 0, 0, (dataIndex-1) * 40)
            button.Visible = true
            
            -- FIX: Store the animation data directly in the button to avoid index issues
            button.AnimationData = data
            
            -- FIX: Only create the click connection once to prevent multiple connections
            if not button.ClickConnection then
                button.ClickConnection = button.MouseButton1Click:Connect(function()
                    pcall(function()
                        if button.AnimationData then
                            setAnimation(button.AnimationData.type, button.AnimationData.ids)
                            Notify("Animation Applied", button.AnimationData.name, 2)
                        end
                    end)
                end)
            end
        else
            button.Visible = false
            button.AnimationData = nil
        end
    end
    
    -- Update canvas size
    scrollFrame.CanvasSize = UDim2.new(0, 0, 0, #filteredAnimationData * 40)
end

-- DEBOUNCED SEARCH
local searchDebounce
searchBar:GetPropertyChangedSignal("Text"):Connect(function()
    if searchDebounce then
        searchDebounce:Disconnect()
    end
    
    searchDebounce = task.delay(0.3, function()
        updateVisibleButtons()
        searchDebounce = nil
    end)
end)

-- LAZY LOAD INITIALIZATION
local function initializeGUI()
    loadAnimations()
    populateAnimationData()
    updateVisibleButtons()
    
    Notify("Animations Loaded", #allAnimationData .. " animations available", 3)
end

-- Initialize after a short delay to prevent initial lag
task.delay(0.5, initializeGUI)

local FLabel = Instance.new("TextLabel")
FLabel.Name = "FLabel"
FLabel.Text = "F"
FLabel.Font = Enum.Font.GothamBold
FLabel.TextScaled = true
FLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
FLabel.BackgroundTransparency = 1
FLabel.Size = UDim2.new(1, 0, 1, 0)
FLabel.Position = UDim2.new(0, 0, 0, 0)
FLabel.Visible = false
FLabel.Parent = frame

-- UPDATED SIZES FOR TALLER WINDOW
local normalSize = getScaledSize(0.3, 0.6) -- TALLER: 60% height
local normalPosition = UDim2.new(0.5, -normalSize.X.Offset / 2, 0.5, -normalSize.Y.Offset / 2)
local smallerSize = getScaledSize(0.1, 0.1) -- Minimized size stays the same
local smallerPosition = UDim2.new(1, -smallerSize.X.Offset - 10, 0, 10) -- Top-right corner
local isSmall = false
local clickCount = 0

local function handleDoubleClick()
    if isSmall then
        -- Return to normal size (TALLER)
        frame.Size = normalSize
        frame.Position = normalPosition
        scrollFrame.Visible = true
        searchBar.Visible = true
        FLabel.Visible = false
    else
        -- Minimize to square in top-right corner
        frame.Size = smallerSize
        frame.Position = smallerPosition
        scrollFrame.Visible = false
        searchBar.Visible = false
        FLabel.Visible = true
    end
    isSmall = not isSmall
end

frame.MouseButton1Click:Connect(function()
    clickCount += 1
    if clickCount == 1 then
        task.delay(0.45, function()
            clickCount = 0
        end)
    elseif clickCount == 2 then
        handleDoubleClick()
        clickCount = 0
    end
end)

scrollFrame:GetPropertyChangedSignal("CanvasPosition"):Connect(function()
    updateVisibleButtons()
end)

local lastAnimations = {}

-- Improved animation handling
local function StopAnim()
    local speaker = Players.LocalPlayer
    local Char = speaker.Character
    if not Char then return end
    local Hum = Char:FindFirstChildOfClass("Humanoid") or Char:FindFirstChildOfClass("AnimationController")
    if Hum then
        for _, track in ipairs(Hum:GetPlayingAnimationTracks()) do
            if track then
                track:Stop(0.1) -- Smooth stop
            end
        end
    end
end

-- Improved reset functions
local function ResetIdle()
    local speaker = Players.LocalPlayer
    local Char = speaker.Character
    if not Char then return end
    local Hum = Char:FindFirstChildOfClass("Humanoid") or Char:FindFirstChildOfClass("AnimationController")
    if not Hum then return end
    
    for _, track in ipairs(Hum:GetPlayingAnimationTracks()) do
        if track and (track.Name == "idle" or track.Name == "IdleAnimation") then
            track:Stop(0.1)
        end
    end
end

local function ResetWalk()
    local speaker = Players.LocalPlayer
    local Char = speaker.Character
    if not Char then return end
    local Hum = Char:FindFirstChildOfClass("Humanoid") or Char:FindFirstChildOfClass("AnimationController")
    if not Hum then return end
    
    for _, track in ipairs(Hum:GetPlayingAnimationTracks()) do
        if track and track.Name == "walk" then
            track:Stop(0.1)
        end
    end
end

local function ResetRun()
    local speaker = Players.LocalPlayer
    local Char = speaker.Character
    if not Char then return end
    local Hum = Char:FindFirstChildOfClass("Humanoid") or Char:FindFirstChildOfClass("AnimationController")
    if not Hum then return end
    
    for _, track in ipairs(Hum:GetPlayingAnimationTracks()) do
        if track and track.Name == "run" then
            track:Stop(0.1)
        end
    end
end

local function ResetJump()
    local speaker = Players.LocalPlayer
    local Char = speaker.Character
    if not Char then return end
    local Hum = Char:FindFirstChildOfClass("Humanoid") or Char:FindFirstChildOfClass("AnimationController")
    if not Hum then return end
    
    for _, track in ipairs(Hum:GetPlayingAnimationTracks()) do
        if track and track.Name == "jump" then
            track:Stop(0.1)
        end
    end
end

local function ResetFall()
    local speaker = Players.LocalPlayer
    local Char = speaker.Character
    if not Char then return end
    local Hum = Char:FindFirstChildOfClass("Humanoid") or Char:FindFirstChildOfClass("AnimationController")
    if not Hum then return end
    
    for _, track in ipairs(Hum:GetPlayingAnimationTracks()) do
        if track and track.Name == "fall" then
            track:Stop(0.1)
        end
    end
end

local function ResetSwim()
    local speaker = Players.LocalPlayer
    local Char = speaker.Character
    if not Char then return end
    local Hum = Char:FindFirstChildOfClass("Humanoid") or Char:FindFirstChildOfClass("AnimationController")
    if not Hum then return end
    
    for _, track in ipairs(Hum:GetPlayingAnimationTracks()) do
        if track and track.Name == "swim" then
            track:Stop(0.1)
        end
    end
end

local function ResetSwimIdle()
    local speaker = Players.LocalPlayer
    local Char = speaker.Character
    if not Char then return end
    local Hum = Char:FindFirstChildOfClass("Humanoid") or Char:FindFirstChildOfClass("AnimationController")
    if not Hum then return end
    
    for _, track in ipairs(Hum:GetPlayingAnimationTracks()) do
        if track and track.Name == "swimidle" then
            track:Stop(0.1)
        end
    end
end

local function ResetClimb()
    local speaker = Players.LocalPlayer
    local Char = speaker.Character
    if not Char then return end
    local Hum = Char:FindFirstChildOfClass("Humanoid") or Char:FindFirstChildOfClass("AnimationController")
    if not Hum then return end
    
    for _, track in ipairs(Hum:GetPlayingAnimationTracks()) do
        if track and track.Name == "climb" then
            track:Stop(0.1)
        end
    end
end

-- FIXED: REMOVED FILE SAVING
local function saveLastAnimations()
    -- File saving removed for compatibility
end

-- BATCHED ANIMATION SYSTEM
local pendingAnimations = {}
local animationApplyDebounce

local function applyPendingAnimations()
    if animationApplyDebounce then return end
    
    animationApplyDebounce = true
    task.delay(0.1, function()
        local player = Players.LocalPlayer
        if not player.Character then 
            animationApplyDebounce = false
            return
        end
        
        local Char = player.Character
        local Animate = Char:FindFirstChild("Animate")
        if not Animate then 
            animationApplyDebounce = false
            return
        end

        pcall(function()
            StopAnim()
            task.wait(0.05)
            
            for animType, animId in pairs(pendingAnimations) do
                lastAnimations[animType] = animId
                
                if animType == "Idle" then
                    ResetIdle()
                    Animate.idle.Animation1.AnimationId = "http://www.roblox.com/asset/?id=" .. animId[1]
                    Animate.idle.Animation2.AnimationId = "http://www.roblox.com/asset/?id=" .. animId[2]
                elseif animType == "Walk" then
                    ResetWalk()
                    Animate.walk.WalkAnim.AnimationId = "http://www.roblox.com/asset/?id=" .. animId
                elseif animType == "Run" then
                    ResetRun()
                    Animate.run.RunAnim.AnimationId = "http://www.roblox.com/asset/?id=" .. animId
                elseif animType == "Jump" then
                    ResetJump()
                    Animate.jump.JumpAnim.AnimationId = "http://www.roblox.com/asset/?id=" .. animId
                elseif animType == "Fall" then
                    ResetFall()
                    Animate.fall.FallAnim.AnimationId = "http://www.roblox.com/asset/?id=" .. animId
                elseif animType == "Swim" and Animate:FindFirstChild("swim") then
                    ResetSwim()
                    Animate.swim.Swim.AnimationId = "http://www.roblox.com/asset/?id=" .. animId
                elseif animType == "SwimIdle" and Animate:FindFirstChild("swimidle") then
                    ResetSwimIdle()
                    Animate.swimidle.SwimIdle.AnimationId = "http://www.roblox.com/asset/?id=" .. animId
                elseif animType == "Climb" then
                    ResetClimb()
                    Animate.climb.ClimbAnim.AnimationId = "http://www.roblox.com/asset/?id=" .. animId
                end
            end
            
            pendingAnimations = {}
            saveLastAnimations()
            
            local humanoid = Char:FindFirstChildOfClass("Humanoid")
            if humanoid then
                humanoid:Move(Vector3.new(0, 0, 0))
            end
        end)
        
        animationApplyDebounce = false
    end)
end

-- Improved setAnimation function
function setAnimation(animationType, animationId)
    if type(animationId) ~= "table" and type(animationId) ~= "string" then return end
    
    pendingAnimations[animationType] = animationId
    applyPendingAnimations()
end

-- FIXED: REMOVED FILE LOADING
local function loadLastAnimations()
    -- File loading removed for compatibility
end

-- OPTIMIZED CHARACTER EVENT HANDLING
local characterLoadDebounce
Players.LocalPlayer.CharacterAdded:Connect(function(character)
    if characterLoadDebounce then return end
    characterLoadDebounce = true
    
    task.wait(1) -- Wait for character to fully load
    
    local hum = character:WaitForChild("Humanoid")
    local animate = character:WaitForChild("Animate", 10)
    if not animate then 
        characterLoadDebounce = false
        return 
    end

    -- Wait a bit more for everything to stabilize
    task.wait(0.5)
    
    -- Batch load saved animations with delays
    local function applyWithDelay(animType, animData)
        if animData then
            task.wait(0.15)
            setAnimation(animType, animData)
        end
    end
    
    if lastAnimations.Idle then applyWithDelay("Idle", lastAnimations.Idle) end
    if lastAnimations.Walk then applyWithDelay("Walk", lastAnimations.Walk) end
    if lastAnimations.Run then applyWithDelay("Run", lastAnimations.Run) end
    if lastAnimations.Jump then applyWithDelay("Jump", lastAnimations.Jump) end
    if lastAnimations.Fall then applyWithDelay("Fall", lastAnimations.Fall) end
    if lastAnimations.Climb then applyWithDelay("Climb", lastAnimations.Climb) end
    if lastAnimations.Swim then applyWithDelay("Swim", lastAnimations.Swim) end
    if lastAnimations.SwimIdle then applyWithDelay("SwimIdle", lastAnimations.SwimIdle) end
    
    characterLoadDebounce = false
end)

local lt = os.clock() - st
Notify("Animation GUI Loaded", string.format("Ready in %.2f seconds", lt), 3)

end)
